<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Destiny2 Armor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #archetype-select-area { margin: 24px 0 16px 0; }
    #archetype-select { min-width: 220px; min-height: 2.5em; }
    #selected-archetype-order { margin: 0.5em 0 1em 0; font-size: 1em; }
    .selected-order-label { font-weight: bold; color: #3366cc; margin-right: 8px; }
    .reset-btn { margin-left: 8px; padding: 2px 8px; font-size: 0.95em; }
    table.data-table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 4px; text-align: center; }
    th { background: #eee; }
    .group-1 { background-color: #f8f9fa !important; }
    .group-2 { background-color: #e3f2fd !important; }
    .group-3 { background-color: #f3e5f5 !important; }
    .group-4 { background-color: #e8f5e8 !important; }
    .group-5 { background-color: #fff3e0 !important; }
    .group-6 { background-color: #fce4ec !important; }
    .group-7 { background-color: #f1f8e9 !important; }
    .group-8 { background-color: #e0f2f1 !important; }
    .group-9 { background-color: #fff8e1 !important; }
    .group-10 { background-color: #f3e5f5 !important; }
    .legendary-header { color: #9c27b0; font-weight: bold; }
    .exotic-header { color: #ff6b35; font-weight: bold; }
    .perks-column { max-width: 400px; word-wrap: break-word; font-size: 0.85em; line-height: 1.3; }
    .base-stat { font-weight: bold; min-width: 60px; }
  </style>
</head>
<body>
  <h1>Destiny2 Armor</h1>
  <form id="csv-form">
    <input type="file" id="csv-file" accept=".csv" required>
    <label>
      <input type="checkbox" id="include-exotic"> Exoticアイテムも含める
    </label>
    <button type="submit">アップロード</button>
  </form>
  <div id="help" style="margin: 24px 0 16px 0; background: #f5f5f5; padding: 16px; border-radius: 5px;">
    <h3>処理内容</h3>
    <ul>
      <li>3つのベース値が0で、かつ「同じ3項目が0」のアイテムが2つ以上存在する防具のみ表示</li>
    </ul>
  </div>
  <div id="archetype-select-area" style="display:none;">
    <label for="archetype-select"><b>Archetype並び順・絞り込み:</b></label>
    <select id="archetype-select" multiple size="6"></select>
    <button id="archetype-apply" type="button">並び替え/絞り込み適用</button>
    <button id="archetype-reset-all" type="button" class="reset-btn">全選択</button>
    <button id="archetype-clear-all" type="button" class="reset-btn">全解除</button>
    <div id="selected-archetype-order"></div>
    <span style="font-size:0.9em;">※クリック順に選択順が反映</span>
  </div>
  <div id="output"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script>
    const IGNORE_PERKS_CLASS_ITEM = [
      "配給", "奉仕", "爆撃手", "ユーティリティーキックスタート", "クラスの泉", "時間膨張",
      "接近防御", "回復のフィニッシャー", "スペシャル・フィニッシャー", "ワン・ツー・フィニッシャー",
      "バルウォーク・フィニッシャー", "ヘルシー・フィニッシャー", "スナップロード・フィニッシャー",
      "エクスプローシブ・フィニッシャー", "ユーティリティー・フィニッシャー", "ベネヴォレント・フィニッシャー",
      "致命的打撃", "死神", "強力誘引"
    ];
    const baseStatOrder = [
      "Health (Base)", "Melee (Base)", "Grenade (Base)",
      "Super (Base)", "Class (Base)", "Weapons (Base)"
    ];
    const typeDisplayOrder = [
      "ヘルメット", "ガントレット", "チェストアーマー", "レッグアーマー"
    ];
    function getLastTypeOrder(type) {
      if (type.includes("クローク")) return 0;
      if (type.includes("バンド")) return 1;
      if (type.includes("紋章")) return 2;
      return 99;
    }
    let latestGroupedResults = [];
    let latestIncludeExotic = false;
    let availableArchetypes = [];
    let selectedArchetypeOrder = [];
    const orderNumbers = ["①","②","③","④","⑤","⑥","⑦","⑧","⑨","⑩","⑪","⑫"];

    function getFilteredPerks(row) {
      const perkColumns = [];
      for (let i = 0; i < 8; i++) {
        perkColumns.push("Perks " + i);
      }
      let perks = [];
      for (const col of perkColumns) {
        if (row[col] && row[col].trim() !== "") {
          if (row["Type"] === "Class Item" && IGNORE_PERKS_CLASS_ITEM.includes(row[col].trim())) continue;
          perks.push(row[col].trim());
        }
      }
      return perks.join(", ");
    }

    document.getElementById("csv-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const fileInput = document.getElementById("csv-file");
      const includeExotic = document.getElementById("include-exotic").checked;
      if (fileInput.files.length === 0) return;
      Papa.parse(fileInput.files[0], {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          filterAndShowArchetypeSelect(results.data, includeExotic);
        }
      });
    });

    function filterAndShowArchetypeSelect(rows, includeExotic) {
      let data = rows.filter(r => r["Type"] !== "Armor Parts");
      if (!includeExotic) data = data.filter(r => r["Rarity"] !== "Exotic");
      data = data.map(row => {
        row._zeroBools = baseStatOrder.map(col => Number(row[col]||0) === 0);
        row._zeroCount = row._zeroBools.filter(z => z).length;
        row._zeroCols = baseStatOrder.filter((col, i) => row._zeroBools[i]).join(", ");
        if (includeExotic) row["Filtered Perks"] = getFilteredPerks(row);
        return row;
      }).filter(row => row._zeroCount === 3);

      const groupMap = new Map();
      data.forEach(row => {
        let key = [
          row["Name"], row["Equippable"], row["Type"], row._zeroCols
        ];
        if (includeExotic) key.push(row["Filtered Perks"]);
        const keyStr = key.join("||");
        if (!groupMap.has(keyStr)) groupMap.set(keyStr, []);
        groupMap.get(keyStr).push(row);
      });
      let groupedResults = [];
      let groupCounter = {}, groupIndex = 1;
      groupMap.forEach((arr, keyStr) => {
        if (arr.length >= 2) {
          arr.forEach(row => {
            if (!groupCounter[keyStr]) groupCounter[keyStr] = groupIndex++;
            row.Group = groupCounter[keyStr];
            row.zeroCols = row._zeroCols;
          });
          groupedResults.push(...arr);
        }
      });
      latestGroupedResults = groupedResults;
      latestIncludeExotic = includeExotic;

      const archetypeSet = new Set();
      groupedResults.forEach(r => {
        if (r["Archetype"] && r["Archetype"].trim() !== "") archetypeSet.add(r["Archetype"]);
      });
      availableArchetypes = Array.from(archetypeSet);
      selectedArchetypeOrder = [...availableArchetypes];

      const select = document.getElementById("archetype-select");
      select.innerHTML = "";
      availableArchetypes.forEach(arc => {
        const opt = document.createElement("option");
        opt.value = arc;
        opt.textContent = arc;
        select.appendChild(opt);
      });
      document.getElementById("archetype-select-area").style.display = "";
      for (let i = 0; i < select.options.length; i++) {
        select.options[i].selected = true;
      }
      updateSelectedOrderUI();
      showTableWithOrderAndArchetype();

      select.onmousedown = function(e) {
        e.preventDefault();
        const value = e.target.value;
        const idx = selectedArchetypeOrder.indexOf(value);
        if (idx === -1) {
          selectedArchetypeOrder.push(value);
        } else {
          selectedArchetypeOrder.splice(idx, 1);
        }
        for (let i = 0; i < select.options.length; i++) {
          select.options[i].selected = selectedArchetypeOrder.includes(select.options[i].value);
        }
        updateSelectedOrderUI();
      };
    }

    function updateSelectedOrderUI() {
      const div = document.getElementById("selected-archetype-order");
      if (selectedArchetypeOrder.length === 0) {
        div.innerHTML = '<span style="color:#999;">（何も選択されていません）</span>';
      } else {
        div.innerHTML = '選択順: ' + selectedArchetypeOrder.map((arc,i)=>`<span class="selected-order-label">${orderNumbers[i]||"?"}</span>${arc}`).join(' → ');
      }
    }

    document.getElementById("archetype-apply").onclick = showTableWithOrderAndArchetype;

    document.getElementById("archetype-reset-all").onclick = function() {
      selectedArchetypeOrder = [...availableArchetypes];
      const select = document.getElementById("archetype-select");
      for (let i = 0; i < select.options.length; i++) {
        select.options[i].selected = true;
      }
      updateSelectedOrderUI();
      showTableWithOrderAndArchetype();
    };

    document.getElementById("archetype-clear-all").onclick = function() {
      selectedArchetypeOrder = [];
      const select = document.getElementById("archetype-select");
      for (let i = 0; i < select.options.length; i++) {
        select.options[i].selected = false;
      }
      updateSelectedOrderUI();
      showTableWithOrderAndArchetype();
    };

    function showTableWithOrderAndArchetype() {
      const archetypeOrderMap = {};
      selectedArchetypeOrder.forEach((arc, idx) => { archetypeOrderMap[arc] = idx; });
      let filtered = latestGroupedResults.filter(r => archetypeOrderMap.hasOwnProperty(r["Archetype"]));
      filtered.sort((a, b) => {
        const rarityOrder = {"Exotic": 0, "Legendary": 1};
        const aR = rarityOrder[a["Rarity"]] ?? 2, bR = rarityOrder[b["Rarity"]] ?? 2;
        if (aR !== bR) return aR - bR;
        if (a["Equippable"] !== b["Equippable"]) return a["Equippable"].localeCompare(b["Equippable"]);
        const aT = typeDisplayOrder.indexOf(a["Type"]);
        const bT = typeDisplayOrder.indexOf(b["Type"]);
        if (aT !== -1 && bT !== -1 && aT !== bT) return aT - bT;
        if (aT === -1 && bT === -1) {
          const aL = getLastTypeOrder(a["Type"]);
          const bL = getLastTypeOrder(b["Type"]);
          if (aL !== bL) return aL - bL;
        } else if (aT === -1) {
          return 1;
        } else if (bT === -1) {
          return -1;
        }
        const ao = archetypeOrderMap[a["Archetype"]];
        const bo = archetypeOrderMap[b["Archetype"]];
        if (ao !== bo) return ao - bo;
        if (a.zeroCols !== b.zeroCols) return a.zeroCols.localeCompare(b.zeroCols);
        return (a["Name"] || "").localeCompare(b["Name"] || "");
      });

      let columns = [
        { title: "Group", data: "Group" },
        { title: "Name", data: "Name" },
        { title: "Tier", data: "Tier" },
        { title: "Type", data: "Type" },
        { title: "Equippable", data: "Equippable" },
        { title: "Power", data: "Power" },
        { title: "Rarity", data: "Rarity" },
        { title: "Archetype", data: "Archetype" },
      ];
      baseStatOrder.forEach(col => columns.push({title: col, data: col, className: "base-stat"}));
      columns.push({title: "Total (Base)", data: "Total (Base)"});
      columns.push({title: "Zero Columns", data: "zeroCols"});
      if (latestIncludeExotic) columns.push({title: "Filtered Perks", data: "Filtered Perks", className: "perks-column"});

      let outputHTML = "";
      ["Exotic", "Legendary"].forEach(rarity => {
        const group = filtered.filter(r => r["Rarity"] === rarity);
        if (group.length === 0) return;
        outputHTML += `<h2 class="${rarity === "Exotic" ? "exotic-header" : "legendary-header"}">Rarity: ${rarity}</h2>`;
        const byEq = {};
        group.forEach(r => {
          byEq[r["Equippable"]] = byEq[r["Equippable"]] || [];
          byEq[r["Equippable"]].push(r);
        });
        for (const [eq, eqGroup] of Object.entries(byEq)) {
          outputHTML += `<h3>Equippable: ${eq}</h3>`;
          const byType = {};
          eqGroup.forEach(r => {
            byType[r["Type"]] = byType[r["Type"]] || [];
            byType[r["Type"]].push(r);
          });
          for (const [type, typeGroup] of Object.entries(byType)) {
            outputHTML += `<h4>Type: ${type}</h4>`;
            outputHTML += `<table class="data-table" id="table-${rarity}-${eq}-${type.replace(/\s/g,"")}" style="margin-bottom:2em;"></table>`;
            setTimeout(() => {
              $(`#table-${rarity}-${eq}-${type.replace(/\s/g,"")}`).DataTable({
                data: typeGroup,
                columns: columns,
                paging: false,
                info: false,
                ordering: false,
                searching: false,
                createdRow: function(row, data) {
                  let groupNum = data.Group;
                  if (groupNum <= 10) {
                    $(row).addClass('group-' + groupNum);
                  }
                }
              });
            }, 0);
          }
        }
      });
      document.getElementById("output").innerHTML = outputHTML;
    }
  </script>
</body>
</html>